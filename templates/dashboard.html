{% extends "base.html" %}

{% block title %}Dashboard - Blood Donation Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Alert container for messages -->
    <div class="alert-container"></div>
    
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-speedometer2 me-2 text-danger"></i>
                        Dashboard
                    </h2>
                    <p class="text-muted mb-0">Blood Donation Management System Overview</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-blood" data-bs-toggle="modal" data-bs-target="#quickAddDonorModal">
                        <i class="bi bi-person-plus me-1"></i>Add Donor
                    </button>
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#quickAddRequestModal">
                        <i class="bi bi-clipboard-plus me-1"></i>New Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stats-number" id="totalDonors">0</div>
                            <div class="stats-label">Total Donors</div>
                        </div>
                        <div class="text-danger">
                            <i class="bi bi-people" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stats-number" id="activeRequests">0</div>
                            <div class="stats-label">Active Requests</div>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-clipboard-heart" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stats-number" id="fulfilledRequests">0</div>
                            <div class="stats-label">Fulfilled Requests</div>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stats-number" id="criticalRequests">0</div>
                            <div class="stats-label">Critical Requests</div>
                        </div>
                        <div class="text-danger">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Blood Requests -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Recent Blood Requests
                    </h5>
                    <a href="/requests" class="btn btn-sm btn-outline-danger">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <!-- Loading indicator -->
                    <div class="text-center py-3 loading-spinner" id="requestsLoading">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2 text-muted">Loading requests...</span>
                    </div>
                    
                    <!-- Recent requests table -->
                    <div class="table-responsive d-none" id="recentRequestsTable">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Blood Group</th>
                                    <th>Urgency</th>
                                    <th>City</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsBody">
                                <!-- Recent requests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty state for requests -->
                    <div class="text-center py-4 d-none" id="noRequestsState">
                        <i class="bi bi-clipboard-heart text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2 mb-0">No blood requests yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blood Group Distribution & Quick Actions -->
        <div class="col-lg-4 mb-4">
            <!-- Blood Group Distribution -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Blood Group Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="bloodGroupChart">
                        <!-- Loading indicator -->
                        <div class="text-center py-3 loading-spinner" id="chartLoading">
                            <div class="spinner-border spinner-border-sm text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2 text-muted">Loading chart...</span>
                        </div>
                        
                        <!-- Blood group list -->
                        <div class="d-none" id="bloodGroupList">
                            <!-- Blood group distribution will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/donors" class="btn btn-outline-primary">
                            <i class="bi bi-people me-2"></i>
                            Manage Donors
                        </a>
                        <a href="/requests" class="btn btn-outline-warning">
                            <i class="bi bi-clipboard-heart me-2"></i>
                            Manage Requests
                        </a>
                        <button class="btn btn-outline-info" onclick="dashboard.searchDonors()">
                            <i class="bi bi-search me-2"></i>
                            Search Donors
                        </button>
                        <a href="/docs" target="_blank" class="btn btn-outline-secondary">
                            <i class="bi bi-book me-2"></i>
                            API Documentation
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Donors -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-check me-2"></i>
                        Recently Registered Donors
                    </h5>
                    <a href="/donors" class="btn btn-sm btn-outline-danger">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <!-- Loading indicator -->
                    <div class="text-center py-3 loading-spinner" id="donorsLoading">
                        <div class="spinner-border spinner-border-sm text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2 text-muted">Loading donors...</span>
                    </div>
                    
                    <!-- Recent donors table -->
                    <div class="table-responsive d-none" id="recentDonorsTable">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Blood Group</th>
                                    <th>City</th>
                                    <th>Contact</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentDonorsBody">
                                <!-- Recent donors will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty state for donors -->
                    <div class="text-center py-4 d-none" id="noDonorsState">
                        <i class="bi bi-people text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2 mb-0">No donors registered yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Donor Modal -->
<div class="modal fade" id="quickAddDonorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Quick Add Donor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickAddDonorForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="quickDonorName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="quickDonorName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="quickDonorBloodGroup" class="form-label">Blood Group *</label>
                            <select class="form-select" id="quickDonorBloodGroup" name="blood_group" required>
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickDonorCity" class="form-label">City *</label>
                            <input type="text" class="form-control" id="quickDonorCity" name="city" required>
                        </div>
                        <div class="col-12">
                            <label for="quickDonorContact" class="form-label">Contact Number *</label>
                            <input type="tel" class="form-control" id="quickDonorContact" name="contact_number" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-blood">
                        <i class="bi bi-check-circle me-1"></i>Add Donor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Add Request Modal -->
<div class="modal fade" id="quickAddRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-plus me-2"></i>Quick Add Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickAddRequestForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="quickPatientName" class="form-label">Patient Name *</label>
                            <input type="text" class="form-control" id="quickPatientName" name="patient_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="quickRequestBloodGroup" class="form-label">Blood Group *</label>
                            <select class="form-select" id="quickRequestBloodGroup" name="blood_group" required>
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickRequestUrgency" class="form-label">Urgency *</label>
                            <select class="form-select" id="quickRequestUrgency" name="urgency" required>
                                <option value="">Select Urgency</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quickRequestCity" class="form-label">City *</label>
                            <input type="text" class="form-control" id="quickRequestCity" name="city" required>
                        </div>
                        <div class="col-md-6">
                            <label for="quickRequestContact" class="form-label">Contact *</label>
                            <input type="tel" class="form-control" id="quickRequestContact" name="contact_number" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-blood">
                        <i class="bi bi-check-circle me-1"></i>Create Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', path='/js/dashboard.js') }}"></script>
{% endblock %}